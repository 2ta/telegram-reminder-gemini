name: Deploy Telegram Bot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} <<'EOSSH'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}
            echo "üöÄ Starting deployment..."
            git fetch origin
            git reset --hard origin/main
            echo "üêç Setting up Python environment..."
            rm -rf .venv
            python3 -m venv .venv
            .venv/bin/pip install --upgrade pip
            .venv/bin/pip install -r requirements.txt
            echo "üóÑÔ∏è Setting up database..."
            echo "import sys" > /tmp/init_db_script.py
            echo "sys.path.append('.')" >> /tmp/init_db_script.py
            echo "try:" >> /tmp/init_db_script.py
            echo "    from src.database import init_db" >> /tmp/init_db_script.py
            echo "    init_db()" >> /tmp/init_db_script.py
            echo "    print('Database initialized successfully!')" >> /tmp/init_db_script.py
            echo "except Exception as e:" >> /tmp/init_db_script.py
            echo "    print(f'Database setup: {e}')" >> /tmp/init_db_script.py
            .venv/bin/python /tmp/init_db_script.py
            echo "üîß Setting up systemd service..."
            # Write the systemd service file with placeholders to avoid GitHub Actions interpolation
            cat > /etc/systemd/system/telegram-reminder-bot.service << 'SERVICEFILE'
            [Unit]
            Description=Telegram Reminder Bot with Gemini AI
            After=network.target

            [Service]
            Type=simple
            User=__SSH_USER__
            WorkingDirectory=__DEPLOY_PATH__
            ExecStart=__DEPLOY_PATH__/.venv/bin/python __DEPLOY_PATH__/start_bot.py
            Restart=on-failure
            RestartSec=10
            StartLimitBurst=3
            StartLimitInterval=60

            # Memory Management
            MemoryHigh=500M
            MemoryMax=800M
            MemorySwapMax=0

            # Environment
            Environment=PYTHONUNBUFFERED=1

            [Install]
            WantedBy=multi-user.target
            SERVICEFILE
            # Replace placeholders with actual values
            sed -i "s|__SSH_USER__|${{ secrets.SSH_USER }}|g" /etc/systemd/system/telegram-reminder-bot.service
            sed -i "s|__DEPLOY_PATH__|${{ secrets.DEPLOY_PATH }}|g" /etc/systemd/system/telegram-reminder-bot.service
            systemctl daemon-reload
            systemctl enable telegram-reminder-bot.service
            echo "üîÑ Restarting bot service..."
            systemctl stop telegram-reminder-bot.service 2>/dev/null || true
            sleep 2
            systemctl start telegram-reminder-bot.service
          EOSSH

      - name: Verify deployment
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            echo "üîç Verifying deployment..."
            sleep 5
            if systemctl is-active --quiet telegram-reminder-bot.service; then
              echo "‚úÖ Bot service is running"
              echo "üìã Recent service logs:"
              journalctl -u telegram-reminder-bot.service --no-pager -n 10
              echo "üîç Checking bot process..."
              if pgrep -f "start_bot.py" > /dev/null; then
                echo "‚úÖ Bot process is running"
              else
                echo "‚ö†Ô∏è Bot process not found, but service is active"
              fi
            else
              echo "‚ùå Bot service is not running"
              echo "üìã Service status:"
              systemctl status telegram-reminder-bot.service --no-pager
              echo "üìã Recent logs:"
              journalctl -u telegram-reminder-bot.service --no-pager -n 20
              exit 1
            fi
          EOF